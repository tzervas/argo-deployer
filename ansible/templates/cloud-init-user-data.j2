#cloud-config
# Cloud-init configuration for ArgoCD VM

hostname: {{ vm_name }}
fqdn: {{ vm_name }}.local
manage_etc_hosts: true

# User configuration
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    shell: /bin/bash
    lock_passwd: false
    ssh_authorized_keys:
{% for key_file in query('fileglob', lookup('env', 'HOME') + '/.ssh/*.pub') %}
      - {{ lookup('file', key_file) }}
{% endfor %}

# Package updates and upgrades
package_update: true
package_upgrade: true

# Packages to install
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - software-properties-common
  - python3-pip
  - python3-bcrypt
  - git
  - wget
  - jq

# Commands to run
runcmd:
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ubuntu

  # Install kubectl
  - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
  - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
  - rm kubectl

  # Install K3s (lightweight Kubernetes)
  - curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode 644 --disable traefik" sh -
  - mkdir -p /home/ubuntu/.kube
  - cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
  - chown -R ubuntu:ubuntu /home/ubuntu/.kube
  - export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

  # Wait for K3s to be ready
  - sleep 30
  - kubectl wait --for=condition=Ready nodes --all --timeout=300s

  # Install ArgoCD
  - kubectl create namespace argocd
  - kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml

  # Wait for ArgoCD to be ready
  - kubectl wait --for=condition=Ready pods --all -n argocd --timeout=600s

  # Patch ArgoCD server for insecure mode (no TLS) and expose on host network
  - kubectl patch svc argocd-server -n argocd -p '{"spec":{"type":"NodePort","ports":[{"port":80,"targetPort":8080,"nodePort":30080,"protocol":"TCP","name":"http"}]}}'
  - kubectl patch deployment argocd-server -n argocd -p '[{"op":"add","path":"/spec/template/spec/containers/0/command/-","value":"--insecure"}]' --type json

  # Install ArgoCD CLI
  - curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/{{ argocd_version }}/argocd-linux-amd64
  - chmod +x /usr/local/bin/argocd

  # Wait for ArgoCD server to restart
  - sleep 30
  - kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s

  # Set custom admin password
  - |
    BCRYPT_HASH='{{ bcrypt_password.stdout }}'
    kubectl -n argocd patch secret argocd-secret -p "{\"data\":{\"admin.password\":\"$(echo -n $BCRYPT_HASH | base64 -w 0)\",\"admin.passwordMtime\":\"$(date +%FT%T%Z | base64 -w 0)\"}}"
  
  # Restart ArgoCD server to apply password
  - kubectl -n argocd rollout restart deployment argocd-server
  - kubectl -n argocd rollout status deployment argocd-server

  # Create completion marker
  - touch /var/lib/cloud/instance/argocd-ready

# Final message
final_message: "ArgoCD VM is ready! System has been up for $UPTIME seconds"

# Power state - keep running
power_state:
  mode: noop
